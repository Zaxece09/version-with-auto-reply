# 🔄 Диаграмма работы системы

## Полный цикл обработки

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ЗАПУСК СИСТЕМЫ                                      │
│                                                                              │
│  main.py → запускает 2 процесса параллельно:                                │
│  ├─ parser_process.py                                                       │
│  └─ email_processor.py                                                      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                       PARSER PROCESS (парсинг)                               │
│                                                                              │
│  1. Отправка "🔎 Начать поиск" → @vo1d3_parser_bot                          │
│  2. Нажать кнопку show_prst|last_parser|last_parser                         │
│  3. Нажать кнопку run_parser_preset|last_parser|                            │
│  4. Ожидать файл от парсера                                                 │
│     ↓                                                                        │
│  5. Файл получен → добавить в очередь                                       │
│     ↓                                                                        │
│  6. Сразу начать новый цикл парсинга (ПАРАЛЛЕЛЬНО!)                         │
│                                                                              │
│  ┌────────────────────────────────────────────────────────┐                 │
│  │  Очередь файлов: [Файл 1] [Файл 2] [Файл 3] ...       │                 │
│  └──────────────────────────┬─────────────────────────────┘                 │
│                             ↓                                                │
│  ┌──────────────────────────────────────────────────────────┐               │
│  │         file_sender_task() (фоновая задача)              │               │
│  │                                                           │               │
│  │  while True:                                             │               │
│  │    if файлы_в_очереди and mailing_completed:            │               │
│  │      отправить_файл_с_retry()                           │               │
│  │      обновить sync_state.json                           │               │
│  └──────────────────────────┬───────────────────────────────┘               │
│                             ↓                                                │
└─────────────────────────────┼───────────────────────────────────────────────┘
                              │
                  Файл отправлен в @Work_machine_hasl_bot
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────────────────┐
│                    @Work_machine_hasl_bot (TARGET_BOT)                       │
│                                                                              │
│  Получен файл                                                               │
│    ↓                                                                         │
│  Проверка файла:                                                            │
│    ├─ Ошибка таймаута? → Parser повторяет отправку (до 10 раз)             │
│    └─ ОК → "⏳ Идет подбор объявлений..."                                   │
│              ↓                                                               │
│         Обработка...                                                        │
│              ↓                                                               │
│         "✅ Подбор завершён! Найдено: X"                                    │
│              ↓                                                               │
└──────────────┼──────────────────────────────────────────────────────────────┘
               │
               ↓ (событие получено email_processor.py)
┌─────────────────────────────────────────────────────────────────────────────┐
│              EMAIL PROCESSOR - Реакция на "Подбор завершён"                 │
│                                                                              │
│  Обнаружено сообщение "✅ Подбор завершён!"                                 │
│    ↓                                                                         │
│  Автоматически отправить команду /send                                      │
│    ↓                                                                         │
│  Бот начинает рассылку                                                      │
│    ↓                                                                         │
│  "✅ Рассылка началась!"                                                    │
│    ↓                                                                         │
│  Обновить sync_state.json: { "mailing_completed": false }                  │
│                                                                              │
│  ┌────────────────────────────────────────────────────┐                     │
│  │  Во время рассылки:                                │                     │
│  │  - Мониторинг ошибок отправки email                │                     │
│  │  - Счетчик consecutive_email_errors                │                     │
│  │  - При 10 ошибках 454-4.7.0 → SHUTDOWN             │                     │
│  └────────────────────────────────────────────────────┘                     │
│                                                                              │
│  Рассылка завершена                                                         │
│    ↓                                                                         │
│  "✅ Рассылка завершена."                                                   │
│    ↓                                                                         │
│  Обновить sync_state.json: { "mailing_completed": true }                   │
│    ↓                                                                         │
│  Parser получает сигнал → отправляет следующий файл из очереди             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│         EMAIL PROCESSOR - Обработка входящих писем (параллельно)            │
│                                                                              │
│  Получено сообщение: "⚡ Получено сообщение на..."                          │
│    ↓                                                                         │
│  Парсинг email (от кого, тема, текст)                                       │
│    ↓                                                                         │
│  Фильтрация:                                                                │
│    ├─ "Kleinanzeige Team"? → ИГНОР                                          │
│    ├─ "<mailer-daemon@googlemail.com>"? → ИГНОР                             │
│    └─ Нормальный email → продолжить                                         │
│         ↓                                                                    │
│  AI анализ (DeepSeek):                                                      │
│    ├─ "ИГНОР" (автоответ) → пропустить                                      │
│    ├─ "НЕТ" (не хочет продавать) → пропустить                               │
│    └─ "ДА" (хочет продавать) → ОБРАБОТКА                                    │
│         ↓                                                                    │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │              Автоматическая обработка (10 шагов)                   │     │
│  │                                                                     │     │
│  │  [1/10] 🔗 Создать ссылку (generate-link:ID)                       │     │
│  │         └─ Retry до 20 раз при ошибке 500                          │     │
│  │         └─ Проверка успеха: "🔗 Ссылка: https://..."               │     │
│  │                                                                     │     │
│  │  [2/10] 📝 Открыть write-message:ID                                │     │
│  │                                                                     │     │
│  │  [3/10] 📬 Открыть список пресетов (show-presets)                  │     │
│  │                                                                     │     │
│  │  [4/10] 📤 Отправить пресет OFIK (preset:108)                      │     │
│  │                                                                     │     │
│  │  [5/10] ⏳ Ждать подтверждения отправки                            │     │
│  │                                                                     │     │
│  │  [6/10] 🔄 ПОВТОРНО открыть write-message:ID                       │     │
│  │         └─ ВАЖНО! Без этого не работают HTML шаблоны               │     │
│  │                                                                     │     │
│  │  [7/10] 📝 Открыть список HTML шаблонов (show-html)                │     │
│  │                                                                     │     │
│  │  [8/10] 📄 Отправить HTML шаблон GO (html:go)                      │     │
│  │                                                                     │     │
│  │  [9/10] ✅ Проверка успешной отправки                              │     │
│  │                                                                     │     │
│  │  [10/10] 🎉 Email полностью обработан!                             │     │
│  └────────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                       ОБРАБОТКА КРИТИЧЕСКИХ ОШИБОК                          │
│                                                                              │
│  Мониторинг сообщений от TARGET_BOT:                                        │
│                                                                              │
│  Получено сообщение с:                                                      │
│  "ошибка при отправке письма ... Invalid login: 454-4.7.0                   │
│   Too many login attempts"                                                  │
│    ↓                                                                         │
│  consecutive_email_errors++                                                 │
│    ↓                                                                         │
│  if consecutive_email_errors >= 10:                                         │
│    ┌──────────────────────────────────────────────┐                         │
│    │  ❌ КРИТИЧЕСКАЯ ОШИБКА: Кончились почты!     │                         │
│    │  ❌ Завершение работы системы                │                         │
│    │  sys.exit(1)                                 │                         │
│    └──────────────────────────────────────────────┘                         │
│                                                                              │
│  При успешной отправке:                                                     │
│    consecutive_email_errors = 0  (сброс счетчика)                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                       sync_state.json (синхронизация)                       │
│                                                                              │
│  Состояния:                                                                 │
│                                                                              │
│  { "mailing_completed": true }   ← Parser может отправлять файлы            │
│  { "mailing_completed": false }  ← Parser ждёт завершения рассылки          │
│                                                                              │
│  Обновляется:                                                               │
│  - Email processor при старте рассылки → false                              │
│  - Email processor при завершении рассылки → true                           │
│                                                                              │
│  Проверяется:                                                               │
│  - Parser перед отправкой каждого файла из очереди                          │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         ЛОГИРОВАНИЕ (config.py)                             │
│                                                                              │
│  LOGGING_CONFIG = {                                                         │
│      'email_processor': True/False,   ← Вкл/выкл логи email процессора      │
│      'parser_process': True/False,    ← Вкл/выкл логи парсера              │
│      'main': True/False,              ← Вкл/выкл логи main                 │
│      ...                                                                    │
│  }                                                                          │
│                                                                              │
│  Лог файлы (если включено):                                                 │
│  - parser.log                                                               │
│  - email_processor.log                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Временная шкала типичного цикла

```
Время  │ Parser                    │ Email Processor           │ TARGET_BOT
───────┼───────────────────────────┼───────────────────────────┼─────────────────
00:00  │ Парсинг [1] начат         │ Ожидание событий          │
00:30  │ Файл 1 получен            │                           │
00:31  │ → Очередь: [Файл 1]       │                           │
00:32  │ Парсинг [2] начат <<<     │                           │ ← Параллельно!
00:33  │ Отправка Файла 1 из очереди                          │
00:34  │                           │                           │ Файл получен
00:35  │                           │                           │ Подбор...
01:00  │ Файл 2 получен            │                           │
01:01  │ → Очередь: [Файл 2]       │                           │
01:02  │ Парсинг [3] начат <<<     │                           │ ← Параллельно!
01:05  │                           │                           │ ✅ Подбор завершён
01:06  │                           │ Отправка /send →          │
01:07  │                           │                           │ ✅ Рассылка началась
01:07  │ ⏳ Ждёт (файл 2 в очереди)│ sync_state: false         │
01:30  │ Файл 3 получен            │                           │
01:31  │ → Очередь: [Файл 2, Файл 3]                          │
01:32  │ Парсинг [4] начат <<<     │                           │ ← Параллельно!
02:00  │                           │                           │ ✅ Рассылка завершена
02:01  │                           │ sync_state: true →        │
02:02  │ Отправка Файла 2 из очереди                          │
02:03  │                           │                           │ Файл получен
02:04  │                           │                           │ Подбор...
...    │ Цикл продолжается         │                           │
```

## Обработка входящего email (параллельно основному циклу)

```
Время  │ Email Processor
───────┼──────────────────────────────────────────────────────────────
01:15  │ ⚡ Входящий email от продавца
01:16  │ Парсинг: от кого, тема, текст
01:17  │ Проверка фильтров (Kleinanzeige Team, mailer-daemon)
01:18  │ 🤖 AI анализ → "ДА" (хочет продавать)
01:19  │ [1/10] 🔗 Создание ссылки... (retry до 20 раз)
01:25  │ ✅ Ссылка создана
01:26  │ [2/10] 📝 Открыть write-message
01:27  │ [3/10] 📬 Показать пресеты
01:28  │ [4/10] 📤 Отправить пресет OFIK
01:30  │ [5/10] ⏳ Ждать подтверждения
01:31  │ [6/10] 🔄 ПОВТОРНО открыть write-message
01:32  │ [7/10] 📝 Показать HTML шаблоны
01:33  │ [8/10] 📄 Отправить HTML GO
01:35  │ ✅ Email полностью обработан!
```

## Ключевые особенности

1. **Параллельность**: Парсинг работает непрерывно, независимо от рассылки
2. **Очередь**: Файлы накапливаются и отправляются по мере завершения рассылок
3. **Retry логика**: Автоматические повторы при ошибках
4. **Синхронизация**: sync_state.json координирует работу процессов
5. **Мониторинг**: Отслеживание критических ошибок email
6. **Автоматизация**: Минимум ручного вмешательства

**Система работает 24/7 полностью автоматически!** 🚀
